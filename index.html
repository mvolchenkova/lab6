<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Система голосования</title>
</head>
<body>
    <p style="font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        font-size: 2em;
        font-weight: 600;
        text-align: center;">
        Проголосуйте за один из вариантов ниже
    </p>
    <div id="vote-section"></div>
    <div id="stats-section"></div>
    
    <!-- Кнопки для скачивания данных -->
    <div id="download-section" style="text-align: center; margin-top: 20px;">
        <button onclick="downloadData('application/json')">Скачать в JSON</button>
        <button onclick="downloadData('text/html')">Скачать в HTML</button>
        <button onclick="downloadData('application/xml')">Скачать в XML</button>
    </div>

    <script>
        async function loadVariants() {
            const response = await fetch('/variants');
            const variants = await response.json();
            const voteSection = document.getElementById('vote-section');

            variants.forEach(variant => {
                const button = document.createElement('button');
                button.innerText = variant.name;
                button.onclick = () => vote(variant.id);
                voteSection.appendChild(button);
            });
        }
        
        async function vote(variantId) {
            const response = await fetch('/vote', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ variantId }),
            });
            if (response.ok) {
                loadStats();
            } else {
                alert('Ошибка: ' + (await response.json()).error);
            }
        }

        async function loadStats() {
            const response = await fetch('/stats');
            const stats = await response.json();
            const statsSection = document.getElementById('stats-section');
            statsSection.innerHTML = '<h2>Статистика голосования</h2>';
            for (const key in stats) {
                statsSection.innerHTML += `<p>${stats[key].name}: ${stats[key].votes} голосов</p>`;
            }
        }

        // Функция для скачивания данных в нужном формате
        async function downloadData(format) {
            const response = await fetch('/data', {
                headers: {
                    'Accept': format
                }
            });
            if (response.ok) {
                const blob = await response.blob(); // Получаем данные как Blob
                const url = window.URL.createObjectURL(blob); // Создаем URL для скачивания
                const a = document.createElement('a'); // Создаем ссылку
                a.style.display = 'none';
                a.href = url;
                a.download = `stats.${format.split('/')[1]}`; // Устанавливаем имя файла
                document.body.appendChild(a);
                a.click(); // Инициализируем скачивание
                window.URL.revokeObjectURL(url); // Освобождаем память
                a.remove(); // Удаляем ссылку
            } else {
                alert('Ошибка при скачивании данных.');
            }
        }

        loadVariants();
        loadStats();
    </script>
</body>
</html>